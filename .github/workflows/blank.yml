name: CI-CD Pipeline

on:
  pull_request:
    types: [closed]

jobs:

  # ----------------------------
  # CI JOB (Runs for ALL branches)
  # ----------------------------
  ci:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java (example)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build
        run: mvn clean compile

      - name: Run Tests
        run: mvn test

      - name: Code Coverage
        run: mvn jacoco:report

      - name: Security Scan (OWASP / Snyk / Trivy)
        run: |
          echo "Run security scans here"
          # example: mvn org.owasp:dependency-check-maven:check

  # --------------------------------
  # DEPLOY TO RELEASE ENV (QA/STAGE)
  # --------------------------------
  deploy-release:
    needs: ci
    if: |
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.base.ref, 'release/')
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Staging
        run: |
          echo "Deploying to STAGING environment"
          # kubectl apply / helm / terraform / ssh

  # ----------------------------
  # DEPLOY TO PROD (MAIN/MASTER)
  # ----------------------------
  deploy-prod:
    needs: ci
    if: |
      github.event.pull_request.merged == true &&
      (github.event.pull_request.base.ref == 'main' ||
       github.event.pull_request.base.ref == 'master')
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Production
        run: |
          echo "Deploying to PRODUCTION"
          # production deployment steps
